<html>
<head>
<meta charset="utf8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css">
<title>结算</title>
<style>
	.itemImg{
		width:200px;
	}
</style>
</head>
<body class="container">

	<ul class="list-group" id="ulItemList">
		
	
	</ul>
	
	<div class="d-flex justify-content-end" style="margin:2% 0 10%;">
		<div>
			<p>总价：<span class="font-weight-bold" id="totalPrice"></span>元</p>
			<p>余额：<span id="balance"></span>元</p>
			<button class="btn btn-primary" style="float:right;" onclick="checkout();">支付</button>
		</div>
	</div>

	
	<ul style="display:none;">
	<li class="list-group-item" id="liItemTemplate" style="display:none;">
		<div class="d-flex flex-row">
		 <div>
		 	<img class="itemImg" src="/goodimgs/00f41d9a-a633-4310-897a-f8d3e9491fe6.jpg">
		 </div>
		 <div class="itemInfo flex-grow-1 d-flex flex-column">
		 	<h3 class="itemTitle">标题</h3>
		 	<p  class="itemDescription flex-grow-1">描述</p>
		 	<div>
		 		库存：<span class="itemNumber font-weight-light"></span>个
		 		<br/>
		 		价格：<span class="itemPrice font-weight-bold"></span>元
		 	</div>
			<div class="d-flex justify-content-between">
				<button class="btn btn-danger" onclick="removeFromCheckout(this.parentElement.parentElement.parentElement.parentElement)">移除</button>
				<div>
					<div class="btn-group w-50" role="group">
						<button class="btn btn-secondary" onclick="let t=$(this).next();let n=parseInt(t.val()); if(n>1)t.val(n-1);calcItemTotalPrice(this.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement);">-</button>
						<input type="number" class="itemBuyNumber text-center w-50" value="1" oninput="calcItemTotalPrice(this.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement);">
						<button class="btn  btn-secondary" onclick="let t=$(this).prev();let n=parseInt(t.val()); t.val(n+1);calcItemTotalPrice(this.parentElement.parentElement.parentElement.parentElement.parentElement.parentElement);">+</button>
					</div>
					<span>价格：<span class="itemTotalPrice font-weight-bold"></span>元</span>
				</div>
			</div>
		 </div>
		</div>
	</li>
	</ul>
	<script type="text/javascript" src="../js/jquery.min.js"></script>
	<script type="text/javascript" src="../js/bootstrap.min.js"></script>
	<script type="text/javascript" src="../js/popper.min.js"></script>
	
	<script>
		itemList = $("#ulItemList");
		function addItemToList(item){
			let newItem = $("#liItemTemplate").clone();
			newItem.css("display", "");
			
			newItem.attr("data-id", item.id);
			newItem.find(".itemImg").attr("src", "/goodimgs/"+item.img);
			newItem.find(".itemTitle").text(item.title);
			newItem.find(".itemDescription").text(item.description);
			newItem.find(".itemPrice").text(item.price);
			newItem.find(".itemNumber").text(item.number);

			itemList.append(newItem);
			calcItemTotalPrice(newItem);
		}
		
		function getPage(){
			itemList.empty();
			let search = location.search;
			$.ajax({
				'url':'/good'+search,
				type : "GET",
		        contentType:'application/json;charset=UTF-8',    
				success : function(result){
					console.log(result);
					if(result.success){
						for(let i of result.data){
							addItemToList(i);
						}
					}else{
						alert("请先登录");
					}
				}
			});
		}
		
		getPage();
		
		function getBalance(){
			$.ajax({
				'url':'/balance',
				type : "GET",
		        contentType:'application/json;charset=UTF-8',    
				success : function(result){
					console.log(result);
					if(result.success){
						$("#balance").text(result.data);
					}else{
						alert("请先登录");
					}
				}
			});
		};
		getBalance();
		
		function removeFromCheckout(goodli){
			let li = $(goodli);
			li.remove();
			calcTotalPrice();
		}
		
		function calcItemTotalPrice(goodli){
			let li = $(goodli);
			let perPrice = parseFloat(li.find(".itemPrice").text());
			let number = parseInt(li.find(".itemBuyNumber").val());
			li.find(".itemTotalPrice").text(perPrice*number);
			calcTotalPrice();
		}
		
		function calcTotalPrice(){
			let totalPrice = 0;
			$(".itemTotalPrice").text(function(index, p){
				p = parseFloat(p);
				totalPrice += isNaN(p)?0:p;
			})
			
			$("#totalPrice").text(totalPrice);
		}
		
		function checkout(){
			let goods=[];
			$("li").each(function(index, li){
				li = $(li);
				if(li.attr("data-id") == undefined){
					return;
				}
				goods.push({
					'id':li.attr("data-id"),
					'number':li.find(".itemBuyNumber").val()
				});
			});
			console.log(goods);
			$.ajax({
				'url':'/checkout',
				type : "post",
				dataType:'json',
				data:JSON.stringify(goods),
		        contentType:'application/json;charset=UTF-8',    
				success : function(result){
					console.log(result);
					if(result.success){
						alert("购买成功！");
						location.assign("/html/index.html");
					}else{
						alert("请先登录");
					}
				}
			});
		}
	</script>
</body>
</html>